<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>Neon Realms — Levels 1–14</title>
<style>
  :root { --ink:#e8f0ff; --bg:#0a0a12; --panel:#101022; --line:#2b2b64; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;overflow:hidden}
  canvas{display:block;width:100vw;height:100vh;touch-action:none;background:#080812}
  #hud{position:fixed;left:8px;top:8px;z-index:11;background:var(--panel);
    border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-size:12px;opacity:.96;min-width:230px}
  #hud .row{display:flex;justify-content:space-between;gap:10px;align-items:center}
  #buttons{position:fixed;left:12px;bottom:16px;display:flex;gap:10px;z-index:10}
  .btn,#dashBtn{width:80px;height:80px;border-radius:16px;border:1px solid var(--line);
    background:radial-gradient(100% 100% at 50% 0%,#1a1a36 0%,#0e0e1f 100%);color:#bfe2ff;font-weight:800;font-size:12px}
  #dashBtn{position:fixed;right:12px;bottom:88px;z-index:10}
  #jumpBtn{position:fixed;right:12px;bottom:16px}
  #overlay{position:fixed;inset:0;display:none;z-index:20;align-items:center;justify-content:center;background:rgba(8,8,16,.55)}
  #overlay .card{background:#0d0d1fdd;border:1px solid #63d7ff;color:var(--ink);padding:16px 22px;border-radius:14px;text-align:center;min-width:320px}
  #overlay h2{margin:0 0 8px 0;font-size:22px}
  #overlay p{margin:6px 0;font-size:14px;color:#bfe2ff}
  #overlay .score{font-size:24px;margin-top:8px}
  #overlay .btnbar{margin-top:12px;display:flex;gap:10px;justify-content:center}
  #overlay button{width:80px;height:80px;border-radius:16px;border:1px solid var(--line);
    background:radial-gradient(100% 100% at 50% 0%,#1a1a36 0%,#0e0e1f 100%);color:#bfe2ff;font-weight:800;font-size:12px}
</style>
</head>
<body>
<canvas id="game"></canvas>

<div id="hud">
  <div class="row"><span id="levelLbl">Level 1/14</span><span id="dashLbl">Dash: READY</span></div>
  <div class="row"><span id="deathLbl">Deaths: 0</span><span id="timerLbl">Time: 0.00</span></div>
</div>

<div id="buttons">
  <button class="btn" id="leftBtn">LEFT</button>
  <button class="btn" id="rightBtn">RIGHT</button>
  <button class="btn" id="jumpBtn">JUMP</button>
</div>
<button id="dashBtn">DASH</button>

<div id="overlay">
  <div class="card">
    <h2 id="ovTitle">Level Complete!</h2>
    <p id="ovBody"></p>
    <div class="score" id="ovScore"></div>
    <div class="btnbar">
      <button id="nextBtn">Next</button>
      <button id="retryBtn">Retry</button>
    </div>
  </div>
</div>

<script>
(() => {
  // ---------- Canvas / scaling ----------
  const DPR=Math.max(1,Math.min(2,devicePixelRatio||1));
  const canvas=document.getElementById('game');
  const ctx=canvas.getContext('2d',{alpha:false});
  const resize=()=>{canvas.width=Math.floor(innerWidth*DPR);canvas.height=Math.floor(innerHeight*DPR);};
  addEventListener('resize',resize); resize();

  // ---------- UI refs ----------
  const levelLbl=document.getElementById('levelLbl');
  const dashLbl=document.getElementById('dashLbl');
  const timerLbl=document.getElementById('timerLbl');
  const deathLbl=document.getElementById('deathLbl');
  const overlay=document.getElementById('overlay');
  const ovTitle=document.getElementById('ovTitle');
  const ovBody=document.getElementById('ovBody');
  const ovScore=document.getElementById('ovScore');
  const nextBtn=document.getElementById('nextBtn');
  const retryBtn=document.getElementById('retryBtn');

  // ---------- Input ----------
  const keys={left:false,right:false,jump:false};
  let jumpEdge=false, lastJumpTapMs=-1;
  function setKey(k,v){keys[k]=v;}
  function tapJump(){jumpEdge=true; lastJumpTapMs=performance.now();}

  function bindHold(el,key){
    el.addEventListener('pointerdown',e=>{e.preventDefault(); setKey(key,true); if(key==='jump')tapJump();},{passive:false});
    el.addEventListener('pointerup',e=>{e.preventDefault(); setKey(key,false);},{passive:false});
    el.addEventListener('touchstart',e=>{e.preventDefault(); setKey(key,true); if(key==='jump')tapJump();},{passive:false});
    el.addEventListener('touchend',e=>{e.preventDefault(); setKey(key,false);},{passive:false});
  }
  bindHold(document.getElementById('leftBtn'),'left');
  bindHold(document.getElementById('rightBtn'),'right');
  bindHold(document.getElementById('jumpBtn'),'jump');
  document.getElementById('dashBtn').addEventListener('pointerup',e=>{e.preventDefault(); tryDash(player.facing||1);});

  addEventListener('keydown',e=>{
    if(e.repeat) return;
    if(e.code==='ArrowLeft'||e.code==='KeyA') setKey('left',true);
    if(e.code==='ArrowRight'||e.code==='KeyD') setKey('right',true);
    if(e.code==='Space'||e.code==='KeyW'||e.code==='ArrowUp'){ setKey('jump',true); tapJump(); }
    if(e.code==='ShiftLeft'||e.code==='ShiftRight') tryDash(player.facing||1);
  });
  addEventListener('keyup',e=>{
    if(e.code==='ArrowLeft'||e.code==='KeyA') setKey('left',false);
    if(e.code==='ArrowRight'||e.code==='KeyD') setKey('right',false);
    if(e.code==='Space'||e.code==='KeyW'||e.code==='ArrowUp') setKey('jump',false);
  });

  // ---------- World helpers ----------
  const groundY=520; // world baseline
  const rect=(x,y,w,h)=>({t:'rect',x,y,w,h});
  const slope=(x1,y1,x2,y2)=>({t:'slope',x1,y1,x2,y2,minX:Math.min(x1,x2),maxX:Math.max(x1,x2)});
  const slopeYAt=(s,x)=>{const t=(x-s.x1)/(s.x2-s.x1); return s.y1 + t*(s.y2-s.y1);};
  const spike=(x,y,w,h)=>({t:'spike',x,y,w,h});
  const laser=(x,y,w,h,axis='y',amp=120,speed=1.3)=>({t:'laser',x,y,w,h,axis,amp,speed,phase:Math.random()*6.28});
  const drone=(x,y,minX,maxX,speed)=>({t:'drone',x,y,w:36,h:24,minX,maxX,dir:1,speed});
  const hover=(x,y,minY,maxY,speed)=>({t:'hover',x,y,w:34,h:22,minY,maxY,dir:1,speed});
  const goal=(x,y)=>({t:'goal',x,y,w:40,h:120});
  const mplat=(x,y,w,h,axis,min,max,speed,pause=0.2)=>({t:'mplat',x,y,w,h,axis,min,max,speed,dir:1,pause,wait:0,prevX:x,prevY:y});
  const crumble=(x,y,w,h,breakDelay=0.5,resetAfter=2.5)=>({t:'crumble',x,y,w,h,breakDelay,resetAfter,active:true,timer:0,resetting:0,stepping:false});

  // ---------- Player / Physics ----------
  const player={x:120,y:420,w:30,h:36,vx:0,vy:0,onGround:false,facing:1, grab:false};
  const MOVE=360, G=2200, JUMP=780;
  const DASH_SPEED=1700, DASH_COOLDOWN=0.85, DJ_MIN=0.06, DJ_MAX=0.30, DJ_BOOST=300;
  let dashCooldown=0, dashStartMs=-1, djDone=false;
  let camX=0, camY=groundY-120, lookAhead=0, last=performance.now();

  function tryDash(dir){
    if(dashCooldown>0) return;
    player.vx = dir*DASH_SPEED;
    player.vy *= 0.35;
    player.facing = Math.sign(dir)||1;
    dashCooldown = DASH_COOLDOWN;
    dashStartMs = performance.now();
    dashLbl.textContent='Dash: COOLDOWN';
    // dash haptic vibe is omitted for web safety
  }

  function overlap(a,b){return a.x<a.x+a.w && b.x<b.x+b.w && a.x+a.w>b.x && a.y+a.h>b.y && a.y<b.y+b.h;}
  function aabb(ax,ay,aw,ah,bx,by,bw,bh){return ax<bx+bw && ax+aw>bx && ay<by+bh && ay+ah>by;}

  // ---------- Rendering helpers ----------
  function drawGlowRect(x,y,w,h,base,glow) {
    ctx.fillStyle=glow; ctx.shadowColor=glow; ctx.shadowBlur=18;
    ctx.fillRect(x,y,w,h);
    ctx.shadowBlur=0; ctx.fillStyle=base; ctx.fillRect(x+4,y+4,w-8,h-8);
  }

  // ---------- Level container ----------
  let levelsList = []; // assigned later
  let levelIndex=0;
  let current = null;

  function loadLevel(i){
    levelIndex = i;
    current = levelsList[levelIndex]();
    player.x = 120; player.y = groundY-40; player.vx=0; player.vy=0; player.onGround=false; player.facing=1; djDone=false;
    camX = Math.max(0, player.x-100); lookAhead=0;
    deathsThis=0; timeStart = performance.now();
    overlay.style.display='none';
    levelLbl.textContent = `Level ${levelIndex+1}/14`;
  }

  // ---------- Run / Score ----------
  let deathsTotal=0, deathsThis=0, timeStart=performance.now();

  nextBtn.onclick=()=> {
    if(levelIndex < levelsList.length-1) loadLevel(levelIndex+1);
    else loadLevel(0);
  };
  retryBtn.onclick=()=> loadLevel(levelIndex);

  // ---------- Level builders 1–10 (kept compact; feel similar to your last build) ----------
  // NOTE: If you had custom layouts earlier, you can swap these later; these play well on phone.
  function buildLevel1(){
    const pads=[],hz=[],en=[],plats=[];
    pads.push(rect(40,groundY,700,30));
    pads.push(rect(1180,groundY,560,30));
    pads.push(rect(2100,groundY,560,30));
    hz.push(spike(860,groundY,220,44));
    pads.push(rect(1120,groundY-160,160,18));
    pads.push(rect(1480,groundY-80,160,18));
    const g=goal(2460,groundY-120);
    return {pads,hz,en,goal:g,length:2600,plats};
  }
  function buildLevel2(){
    const pads=[],hz=[],en=[],plats=[];
    pads.push(rect(40,groundY,640,30));
    pads.push(rect(1220,groundY,650,30));
    hz.push(spike(720,groundY,320,44));
    pads.push(rect(1080,groundY-140,180,18));
    plats.push(mplat(860,groundY-90,160,20,'x',720,1040,180,0.08));
    const g=goal(1620,groundY-120);
    return {pads,hz,en,goal:g,length:1780,plats};
  }
  function buildLevel3(){
    const pads=[],hz=[],en=[],plats=[];
    pads.push(rect(40,groundY,680,30));
    pads.push(rect(1840,groundY,700,30));
    hz.push(spike(820,groundY,260,44));
    plats.push(mplat(740,groundY-96,170,20,'x',700,1080,185,0.08));
    pads.push(rect(1140,groundY-150,210,18));
    hz.push(laser(1360,groundY-230,18,240,'y',120,1.35));
    pads.push(rect(1560,groundY-190,210,18));
    const g=goal(1980,groundY-120);
    return {pads,hz,en,goal:g,length:2120,plats};
  }
  function buildLevel4(){
    const pads=[],hz=[],en=[],plats=[];
    pads.push(rect(40,groundY,720,30));
    pads.push(rect(2680,groundY,820,30));
    hz.push(laser(820,groundY-60,320,16,'x',170,1.24));
    hz.push(spike(1200,groundY,260,44));
    pads.push(rect(1100,groundY-150,210,18));
    plats.push(mplat(1400,groundY-300,160,20,'y',groundY-340,groundY-140,145,0.10));
    pads.push(rect(1580,groundY-240,200,18));
    pads.push(slope(1780,groundY-240,2000,groundY-40));
    pads.push(rect(2120,groundY-200,220,18));
    const g=goal(2860,groundY-120);
    return {pads,hz,en,goal:g,length:3000,plats};
  }
  function buildLevel5(){ // moving platforms intro+ (harder)
    const pads=[],hz=[],en=[],plats=[];
    pads.push(rect(40,groundY,520,30));
    pads.push(rect(1500,groundY,520,30));
    pads.push(rect(1150,groundY-140,200,18));
    pads.push(rect(1750,groundY-120,220,18));
    pads.push(rect(1980,groundY-220,200,18)); // high ledge
    hz.push(spike(880,groundY,260,44));
    hz.push(laser(1660,groundY-230,18,240,'y',120,1.35));
    plats.push(mplat(780,groundY-86,190,20,'x',700,1280,110,0.22)); // faster per your ask
    plats.push(mplat(1620,groundY-180,160,20,'y',groundY-290,groundY-120,95,0.20));
    en.push(drone(1880,groundY-170,1820,2020,145));
    const g=goal(2120,groundY-220);
    return {pads,hz,en,goal:g,length:2300,plats};
  }
  function buildLevel6(){
    const pads=[],hz=[],en=[],plats=[];
    pads.push(rect(40,groundY,700,30));
    pads.push(rect(2600,groundY,820,30));
    pads.push(crumble(860,groundY-120,120,20,0.55,2.4));
    pads.push(rect(1040,groundY-150,200,18));
    hz.push(spike(1240,groundY,260,44));
    plats.push(mplat(1180,groundY-100,170,20,'x',1120,1480,185,0.08));
    pads.push(rect(1540,groundY-180,200,18));
    hz.push(laser(1760,groundY-230,18,240,'y',120,1.38));
    pads.push(rect(1920,groundY-200,210,18));
    const g=goal(2780,groundY-120);
    return {pads,hz,en,goal:g,length:2940,plats};
  }
  function buildLevel7(){
    const pads=[],hz=[],en=[],plats=[];
    pads.push(rect(40,groundY,720,30));
    pads.push(rect(2800,groundY,830,30));
    hz.push(laser(820,groundY-60,330,16,'x',175,1.26));
    pads.push(crumble(980,groundY-160,120,20,0.55,2.6));
    pads.push(rect(1140,groundY-200,200,18));
    en.push(hover(1340,groundY-260,groundY-320,groundY-160,84));
    hz.push(spike(1500,groundY,320,44));
    plats.push(mplat(1460,groundY-100,180,20,'x',1420,1820,190,0.08));
    pads.push(rect(1880,groundY-180,210,18));
    const g=goal(2980,groundY-120);
    return {pads,hz,en,goal:g,length:3140,plats};
  }
  function buildLevel8(){
    const pads=[],hz=[],en=[],plats=[];
    pads.push(rect(40,groundY,720,30));
    pads.push(rect(3000,groundY,860,30));
    plats.push(mplat(820,groundY-300,160,20,'y',groundY-330,groundY-140,145,0.10));
    pads.push(rect(1000,groundY-240,200,18));
    hz.push(laser(1180,groundY-70,320,16,'x',170,1.28));
    hz.push(laser(1500,groundY-60,300,16,'x',165,1.30));
    pads.push(rect(1680,groundY-210,210,18));
    pads.push(crumble(1820,groundY-180,120,20,0.55,2.5));
    hz.push(spike(1940,groundY,320,44));
    plats.push(mplat(1900,groundY-100,170,20,'x',1860,2220,190,0.08));
    pads.push(rect(2260,groundY-180,210,18));
    const g=goal(3180,groundY-120);
    return {pads,hz,en,goal:g,length:3340,plats};
  }
  function buildLevel9(){
    const pads=[],hz=[],en=[],plats=[];
    pads.push(rect(40,groundY,740,30));
    pads.push(rect(3200,groundY,860,30));
    hz.push(spike(860,groundY,260,44));
    pads.push(rect(1120,groundY-160,210,18));
    en.push(drone(1320,groundY-170,1260,1560,185));
    hz.push(laser(1580,groundY-230,18,240,'y',120,1.44));
    pads.push(slope(1700,groundY-220,1900,groundY-40));
    pads.push(rect(1960,groundY-200,210,18));
    plats.push(mplat(2140,groundY-300,160,20,'y',groundY-340,groundY-140,145,0.10));
    pads.push(rect(2320,groundY-240,200,18));
    const g=goal(3380,groundY-120);
    return {pads,hz,en,goal:g,length:3540,plats};
  }
  function buildLevel10(){
    const pads=[],hz=[],en=[],plats=[];
    pads.push(rect(40,groundY,760,30));
    pads.push(rect(3600,groundY,880,30));
    hz.push(laser(880,groundY-60,320,16,'x',170,1.30));
    hz.push(laser(1220,groundY-60,320,16,'x',170,1.36));
    pads.push(crumble(1100,groundY-160,120,20,0.55,2.6));
    pads.push(rect(1320,groundY-200,200,18));
    hz.push(spike(1500,groundY,360,44));
    plats.push(mplat(1460,groundY-100,180,20,'x',1420,1820,195,0.08));
    pads.push(rect(1880,groundY-180,210,18));
    plats.push(mplat(2060,groundY-300,160,20,'y',groundY-340,groundY-140,145,0.10));
    pads.push(rect(2240,groundY-240,200,18));
    en.push(hover(2360,groundY-260,groundY-320,groundY-160,82));
    const g=goal(3780,groundY-120);
    return {pads,hz,en,goal:g,length:3940,plats};
  }

  // ---------- Level 11–14 (from our plan) ----------
  function buildLevel11(){
    const pads=[],hz=[],en=[],plats=[];
    pads.push(rect(40, groundY, 640, 30));
    pads.push(rect(4300, groundY, 800, 30));
    hz.push(spike(740, groundY, 200, 44));
    pads.push(crumble(660, groundY-90, 120, 20, 0.55, 2.6));
    pads.push(rect(880, groundY-120, 200, 18));
    hz.push(laser(1120, groundY-230, 18, 240, 'y', 120, 1.55));
    hz.push(laser(1160, groundY-230, 18, 240, 'y', 120, 1.40));
    plats.push(mplat(1240, groundY-92, 170, 20, 'x', 1200, 1580, 180, 0.08));
    pads.push(rect(1620, groundY-140, 210, 18));
    hz.push(laser(1780, groundY-70, 320, 16, 'x', 170, 1.25));
    pads.push(crumble(1720, groundY-120, 110, 20, 0.50, 2.6));
    pads.push(crumble(1860, groundY-150, 110, 20, 0.50, 2.6));
    pads.push(crumble(2000, groundY-180, 110, 20, 0.50, 2.6));
    pads.push(rect(2140, groundY-210, 210, 18));
    hz.push(spike(2260, groundY, 300, 44));
    plats.push(mplat(2220, groundY-280, 160, 20, 'y', groundY-320, groundY-120, 135, 0.10));
    pads.push(rect(2420, groundY-220, 210, 18));
    hz.push(laser(2580, groundY-60, 300, 16, 'x', 160, 1.32));
    hz.push(laser(2880, groundY-230, 18, 260, 'y', 140, 1.46));
    pads.push(crumble(2960, groundY-190, 120, 20, 0.55, 2.4));
    pads.push(rect(3100, groundY-210, 210, 18));
    en.push(drone(1980, groundY-170, 1920, 2180, 180));
    en.push(hover(2700, groundY-260, groundY-320, groundY-160, 84));
    return {pads,hz,en,goal:goal(4460,groundY-120),length:4460,plats};
  }
  function buildLevel12(){
    const pads=[],hz=[],en=[],plats=[];
    pads.push(rect(40, groundY, 660, 30));
    pads.push(rect(4700, groundY, 820, 30));
    hz.push(spike(780, groundY, 260, 44));
    plats.push(mplat(700, groundY-96, 170, 20, 'x', 660, 1060, 175, 0.08));
    pads.push(rect(1120, groundY-150, 210, 18));
    hz.push(laser(1300, groundY-70, 320, 16, 'x', 175, 1.22));
    hz.push(laser(1640, groundY-60, 300, 16, 'x', 165, 1.30));
    pads.push(rect(1820, groundY-200, 210, 18));
    pads.push(crumble(1960, groundY-220, 120, 20, 0.55, 2.5));
    plats.push(mplat(2080, groundY-300, 160, 20, 'y', groundY-330, groundY-120, 140, 0.10));
    pads.push(rect(2260, groundY-240, 210, 18));
    plats.push(mplat(2380, groundY-110, 150, 20, 'x', 2340, 2600, 185, 0.08));
    plats.push(mplat(2660, groundY-130, 200, 20, 'x', 2580, 2980, 175, 0.10));
    en.push(drone(2500, groundY-170, 2420, 2880, 190));
    hz.push(laser(3060, groundY-230, 18, 260, 'y', 140, 1.48));
    pads.push(slope(3140, groundY-220, 3360, groundY-30));
    hz.push(spike(3400, groundY, 200, 44));
    pads.push(rect(3620, groundY-160, 210, 18));
    return {pads,hz,en,goal:goal(4860,groundY-120),length:4860,plats};
  }
  function buildLevel13(){
    const pads=[],hz=[],en=[],plats=[];
    pads.push(rect(40, groundY, 680, 30));
    pads.push(rect(5100, groundY, 840, 30));
    plats.push(mplat(780, groundY-300, 160, 20, 'y', groundY-330, groundY-140, 140, 0.10));
    pads.push(rect(960, groundY-240, 210, 18));
    plats.push(mplat(1120, groundY-320, 160, 20, 'y', groundY-350, groundY-150, 145, 0.10));
    pads.push(rect(1300, groundY-260, 210, 18));
    hz.push(laser(1460, groundY-70, 320, 16, 'x', 170, 1.26));
    hz.push(laser(1780, groundY-60, 300, 16, 'x', 165, 1.32));
    pads.push(rect(1960, groundY-210, 210, 18));
    pads.push(crumble(2080, groundY-180, 120, 20, 0.55, 2.6));
    pads.push(crumble(2200, groundY-150, 120, 20, 0.55, 2.6));
    hz.push(spike(2340, groundY, 300, 44));
    plats.push(mplat(2280, groundY-100, 170, 20, 'x', 2240, 2600, 185, 0.08));
    pads.push(rect(2640, groundY-180, 210, 18));
    en.push(hover(2760, groundY-260, groundY-320, groundY-160, 86));
    en.push(drone(2980, groundY-170, 2900, 3200, 190));
    pads.push(slope(2840, groundY-200, 3020, groundY-40));
    pads.push(rect(3120, groundY-200, 210, 18));
    return {pads,hz,en,goal:goal(5260,groundY-120),length:5260,plats};
  }
  function buildLevel14(){
    const pads=[],hz=[],en=[],plats=[];
    pads.push(rect(40, groundY, 700, 30));
    pads.push(rect(5600, groundY, 860, 30));
    hz.push(spike(820, groundY, 260, 44));
    plats.push(mplat(740, groundY-96, 170, 20, 'x', 700, 1080, 185, 0.08));
    pads.push(rect(1140, groundY-150, 210, 18));
    hz.push(laser(1300, groundY-70, 320, 16, 'x', 175, 1.24));
    hz.push(laser(1640, groundY-60, 300, 16, 'x', 165, 1.30));
    hz.push(laser(1940, groundY-55, 280, 16, 'x', 160, 1.36));
    pads.push(rect(2140, groundY-210, 210, 18));
    plats.push(mplat(2260, groundY-300, 160, 20, 'y', groundY-340, groundY-140, 145, 0.10));
    pads.push(rect(2440, groundY-240, 200, 18));
    pads.push(crumble(2560, groundY-220, 120, 20, 0.55, 2.6));
    pads.push(crumble(2680, groundY-190, 120, 20, 0.55, 2.6));
    pads.push(rect(2820, groundY-210, 200, 18));
    hz.push(spike(2940, groundY, 360, 44));
    plats.push(mplat(2900, groundY-100, 180, 20, 'x', 2860, 3260, 195, 0.08));
    en.push(drone(3040, groundY-170, 2960, 3340, 195));
    hz.push(laser(3340, groundY-230, 18, 260, 'y', 140, 1.50));
    pads.push(rect(3440, groundY-220, 210, 18));
    hz.push(laser(3580, groundY-60, 320, 16, 'x', 165, 1.34));
    en.push(hover(3740, groundY-260, groundY-320, groundY-160, 88));
    pads.push(slope(3860, groundY-220, 4080, groundY-40));
    pads.push(rect(4140, groundY-200, 220, 18));
    return {pads,hz,en,goal:goal(5760,groundY-120),length:5760,plats};
  }

  // ---------- Level list ----------
  levelsList = [
    buildLevel1, buildLevel2, buildLevel3, buildLevel4, buildLevel5,
    buildLevel6, buildLevel7, buildLevel8, buildLevel9, buildLevel10,
    buildLevel11, buildLevel12, buildLevel13, buildLevel14
  ];

  // ---------- Game loop / collisions ----------
  let deaths=0;
  function resetToStart(){ deaths++; deathsThis++; deathLbl.textContent=`Deaths: ${deaths}`;
    player.x=120; player.y=groundY-40; player.vx=0; player.vy=0; player.onGround=false; djDone=false; dashCooldown=0; }

  function drawWorld(cur,camx,camy){
    const {pads,hz,en,goal:lengthGoal,length,plats}=cur;
    ctx.setTransform(1,0,0,1,0,0); ctx.fillStyle='#0a0a12'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.setTransform(DPR,0,0,DPR, -camx*DPR, -camy*DPR);

    // grid
    ctx.strokeStyle='rgba(80,100,160,0.08)'; ctx.lineWidth=1;
    for(let x=Math.floor((camx)/80)*80; x<camx+canvas.width/DPR+80; x+=80){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,9999); ctx.stroke(); }
    for(let y=Math.floor((camy)/80)*80; y<camy+canvas.height/DPR+80; y+=80){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(99999,y); ctx.stroke(); }

    // platforms
    ctx.fillStyle='#0e9bd8';
    pads.forEach(p=>{
      if(p.t==='rect') drawGlowRect(p.x,p.y,p.w,p.h,'#27c3ff','#0bf');
      else if(p.t==='slope'){ ctx.fillStyle='rgba(0,200,255,0.15)'; ctx.beginPath();
        ctx.moveTo(p.x1,p.y1); ctx.lineTo(p.x2,p.y2); ctx.lineTo(p.x2,p.y2+18); ctx.lineTo(p.x1,p.y1+18); ctx.closePath(); ctx.fill();
        ctx.fillStyle='#27c3ff'; }
      else if(p.t==='crumble'){ const a=p.active?1:0.2; ctx.globalAlpha=a; drawGlowRect(p.x,p.y,p.w,p.h,'#27c3ff','#5ef'); ctx.globalAlpha=1; }
    });

    // movers
    plats.forEach(m=>{ drawGlowRect(m.x,m.y,m.w,m.h,'#27c3ff','#5ef'); });

    // hazards
    hz.forEach(h=>{
      if(h.t==='spike'){ ctx.fillStyle='#ff8aa6aa'; drawGlowRect(h.x,h.y,h.w,h.h,'#ff3b73','#ff8ab2'); }
      else if(h.t==='laser'){ const ox=h.axis==='x'?Math.sin(h.phase)*h.amp:0; const oy=h.axis==='y'?Math.sin(h.phase)*h.amp:0;
        ctx.fillStyle='#ffdd66aa'; drawGlowRect(h.x+ox,h.y+oy,h.w,h.h,'#ffd54a','#ffd36a'); }
    });

    // enemies
    en.forEach(e=>{
      ctx.fillStyle = e.t==='drone' ? '#ff6a89' : '#f0a15e';
      drawGlowRect(e.x,e.y,e.w,e.h, ctx.fillStyle, ctx.fillStyle);
    });

    // goal
    const g=cur.goal;
    // portal ring + arrow
    ctx.save();
    ctx.translate(g.x+g.w/2, g.y+g.h/2);
    const t=performance.now()/600;
    ctx.strokeStyle='#9effff'; ctx.lineWidth=6;
    ctx.shadowColor='#7ef'; ctx.shadowBlur=18;
    ctx.beginPath(); ctx.arc(0,0,32,0,Math.PI*2); ctx.stroke();
    ctx.shadowBlur=0;
    ctx.fillStyle='#bff';
    ctx.beginPath(); ctx.moveTo(0,-42); ctx.lineTo(10,-24); ctx.lineTo(-10,-24); ctx.closePath(); ctx.fill();
    ctx.restore();

    // player
    drawGlowRect(player.x,player.y,player.w,player.h,'#a8ffe8','#7fffd4');

    // dash trail
    if(performance.now()-dashStartMs<110){
      ctx.fillStyle='rgba(127,255,212,0.15)'; const k=1-((performance.now()-dashStartMs)/110);
      ctx.fillRect(player.x-(player.facing>0?60:0), player.y+10, 60, 6*k);
    }

    // UI fixed things: nothing extra
  }

  function update(dt){
    const cur=current; if(!cur) return;
    // timers
    dashCooldown=Math.max(0,dashCooldown-dt);
    dashLbl.textContent = dashCooldown>0? 'Dash: COOLDOWN' : 'Dash: READY';

    // input
    let ax=0; if(keys.left) ax-=1; if(keys.right) ax+=1;
    player.facing = ax!==0? Math.sign(ax): player.facing;

    // horizontal accel
    const target = ax*MOVE; const accel = 2800;
    player.vx += Math.max(-accel*dt, Math.min(accel*dt, target-player.vx));

    // gravity
    player.vy += G*dt;

    // jump (coyote + dash-jump window)
    const now=performance.now();
    const dashJumpWindow = (now-dashStartMs>=DJ_MIN*1000 && now-dashStartMs<=DJ_MAX*1000);
    if(jumpEdge){
      if(player.onGround){ player.vy=-JUMP; player.onGround=false; }
      else if(dashJumpWindow && !djDone){ player.vy = -JUMP - DJ_BOOST; djDone=true; }
      jumpEdge=false;
    }

    // integrate
    let nx = player.x + player.vx*dt;
    let ny = player.y + player.vy*dt;

    // movers move & carry
    cur.plats.forEach(m=>{
      m.prevX=m.x; m.prevY=m.y;
      if(m.wait>0){ m.wait-=dt; return; }
      if(m.axis==='x'){ m.x += m.dir*m.speed*dt; if(m.x<m.min){m.x=m.min; m.dir=1; m.wait=m.pause;} if(m.x>m.max){m.x=m.max; m.dir=-1; m.wait=m.pause;} }
      else { m.y += m.dir*m.speed*dt; if(m.y<m.min){m.y=m.min; m.dir=1; m.wait=m.pause;} if(m.y>m.max){m.y=m.max; m.dir=-1; m.wait=m.pause;} }
    });

    // collisions (simple AABB)
    player.onGround=false;
    // vertical resolve first
    let px=nx, py=ny;

    // collide with rects + crumble + slopes + movers
    const solids = [...cur.pads, ...cur.plats];
    for(const s of solids){
      if(s.t==='slope'){
        if(px+player.w>Math.min(s.x1,s.x2) && px<s.maxX){
          const yAt = slopeYAt(s, px+player.w/2);
          if(py+player.h>yAt && player.vy>=0 && py+player.h<yAt+40){
            py = yAt-player.h; player.vy=0; player.onGround=true; djDone=false;
          }
        }
      } else {
        const sx = s.x, sy=s.y, sw=s.w, sh=s.h;
        // vertical
        if(aabb(px,py,player.w,player.h,sx,sy,sw,sh)){
          if(player.vy>0 && (player.y+player.h)<=sy+2){ py=sy-player.h; player.vy=0; player.onGround=true; djDone=false;
            if(s.t==='crumble' && s.active){ s.stepping=true; }
          } else if(player.vy<0 && player.y>=sy+sh-2){ py=sy+sh; player.vy=0; }
        }
        // horizontal
        if(aabb(px,py,player.w,player.h,sx,sy,sw,sh)){
          if(player.vx>0 && player.x+player.w<=sx+2){ px=sx-player.w; player.vx=0; }
          else if(player.vx<0 && player.x>=sx+sw-2){ px=sx+sw; player.vx=0; }
        }
        // carry with mover
        if(s.t==='mplat' && player.onGround && (player.y+player.h)<=s.y+2 && (player.x+player.w*0.5)>=s.x && (player.x+player.w*0.5)<=s.x+s.w){
          px += (s.x - s.prevX); py += (s.y - s.prevY);
        }
      }
    }

    // crumble state update
    cur.pads.forEach(p=>{
      if(p.t!=='crumble') return;
      if(p.stepping && p.active){ p.timer+=dt; if(p.timer>=p.breakDelay){ p.active=false; p.resetting=p.resetAfter; p.timer=0; } }
      p.stepping=false;
      if(!p.active){ p.resetting-=dt; if(p.resetting<=0){ p.active=true; } }
    });

    // hazards & enemies & bounds
    // lasers animate
    cur.hz.forEach(h=>{ if(h.t==='laser'){ h.phase += h.speed*dt; } });

    // enemy move
    cur.en.forEach(e=>{
      if(e.t==='drone'){ e.x += e.dir*e.speed*dt; if(e.x<e.minX){e.x=e.minX; e.dir=1;} if(e.x>e.maxX){e.x=e.maxX; e.dir=-1;} }
      else if(e.t==='hover'){ e.y += e.dir*e.speed*dt; if(e.y<e.minY){e.y=e.minY; e.dir=1;} if(e.y>e.maxY){e.y=e.maxY; e.dir=-1;} }
    });

    // hazard overlap
    const hurt = ()=>{
      resetToStart();
    };

    for(const h of cur.hz){
      if(h.t==='spike'){ if(aabb(px,py,player.w,player.h,h.x,h.y,h.w,h.h)) { hurt(); return; } }
      else if(h.t==='laser'){
        const ox = h.axis==='x'? Math.sin(h.phase)*h.amp : 0;
        const oy = h.axis==='y'? Math.sin(h.phase)*h.amp : 0;
        if(aabb(px,py,player.w,player.h, h.x+ox,h.y+oy,h.w,h.h)){ hurt(); return; }
      }
    }
    for(const e of cur.en){
      if(aabb(px,py,player.w,player.h,e.x,e.y,e.w,e.h)){ hurt(); return; }
    }

    if(py>groundY+800 || px<0) { resetToStart(); return; }

    // commit
    player.x=px; player.y=py;

    // camera
    lookAhead = 0.85*lookAhead + 0.15*(player.facing*130 + player.vx*0.15);
    camX = Math.max(0, player.x - canvas.width/DPR/2 + lookAhead);
    camY = Math.max(0, groundY - canvas.height/DPR*0.65);

    // goal check
    const g=cur.goal;
    if(aabb(player.x,player.y,player.w,player.h,g.x,g.y,g.w,g.h)){
      // complete
      const t = (performance.now()-timeStart)/1000;
      ovTitle.textContent = (levelIndex===levelsList.length-1)? 'Demo Complete!' : 'Level Complete!';
      ovBody.textContent  = (levelIndex===levelsList.length-1)? 'You cleared Levels 1–14.' : `Nice run!`;
      ovScore.textContent = `Time: ${t.toFixed(2)}s   |   Deaths (level): ${deathsThis}`;
      overlay.style.display='flex';
    }

    // timer ui
    const tnow=(performance.now()-timeStart)/1000;
    timerLbl.textContent=`Time: ${tnow.toFixed(2)}`;
  }

  function tick(){
    const now=performance.now(); const dt=Math.min(0.033,(now-last)/1000); last=now;
    update(dt);
    drawWorld(current, camX, camY);
    requestAnimationFrame(tick);
  }

  // ---------- Start ----------
  loadLevel(0);
  tick();
})();
</script>
</body>
</html>
